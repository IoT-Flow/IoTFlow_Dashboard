name: CD - Dashboard Backend

on:
  push:
    branches: [master, develop, main]
    paths:
      - 'iotflow-backend/**'
      - '.github/workflows/cd-backend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options: ['staging', 'production']
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        type: boolean
        default: false

env:
  ACR_REGISTRY: iotflow.azurecr.io
  IMAGE_NAME: dashboard-backend
  AKS_CLUSTER: iotflow-aks
  AKS_RESOURCE_GROUP: service-web
  NAMESPACE: iotflow

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Determine Environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/master" || "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Check deployment
        id: check
        run: |
          if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./iotflow-backend
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}
            ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          provenance: false

      - name: Output image tag
        run: |
          echo "âœ… Image built: ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}"

  deploy:
    needs: [setup, build]
    if: needs.setup.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER }}

      - name: Deploy to AKS
        run: |
          echo "ðŸš€ Deploying dashboard-backend to ${{ needs.setup.outputs.environment }}"
          
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.sha }}"
          echo "ðŸ“¦ Image: $IMAGE_TAG"
          
          kubectl set image deployment/dashboard-backend \
            dashboard-backend=$IMAGE_TAG \
            -n ${{ env.NAMESPACE }}
          
          echo "â³ Waiting for rollout..."
          kubectl rollout status deployment/dashboard-backend -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          kubectl get pods -l app=dashboard-backend -n ${{ env.NAMESPACE }}
          kubectl wait --for=condition=ready pod -l app=dashboard-backend -n ${{ env.NAMESPACE }} --timeout=300s
          echo "âœ… Deployment verified"

  notify:
    needs: [setup, build, deploy]
    if: always() && needs.setup.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            STATUS="âœ… SUCCESS"
          else
            STATUS="âŒ FAILED"
          fi
          
          echo "## ðŸš€ Dashboard Backend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
