<!DOCTYPE html>
<html>

<head>
  <title>Login Test - Minimal Simulation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .form-group {
      margin: 15px 0;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    .result {
      margin: 15px 0;
      padding: 10px;
      border-radius: 4px;
    }

    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    pre {
      font-size: 12px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .dashboard {
      display: none;
      background: #28a745;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîê IoTFlow Login Simulation</h1>

    <div id="loginForm">
      <div class="form-group">
        <label for="email">Email/Username:</label>
        <input type="text" id="email" value="admin@iotflow.com" />
      </div>
      <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" value="admin123" />
      </div>
      <button onclick="simulateLogin()">üöÄ Simulate Login</button>
      <button onclick="clearLocalStorage()">üóëÔ∏è Clear Storage</button>
      <button onclick="checkAuthentication()">üîç Check Auth</button>
    </div>

    <div id="dashboard" class="dashboard">
      <h2>üéâ Welcome to IoTFlow Dashboard!</h2>
      <p id="welcomeMessage"></p>
      <button onclick="simulateLogout()">üö™ Logout</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    // Simulate the exact same flow as the React app
    let isAuthenticated = false;
    let currentUser = null;
    let isLoading = true;

    function log(message, type = 'info') {
      const resultsDiv = document.getElementById('results');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      resultsDiv.innerHTML += `<div class="result ${className}"><strong>[${timestamp}]</strong> ${message}</div>`;
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('results').innerHTML = '';
    }

    function updateUI() {
      const loginForm = document.getElementById('loginForm');
      const dashboard = document.getElementById('dashboard');
      const welcomeMessage = document.getElementById('welcomeMessage');

      if (isLoading) {
        log('üîÑ Loading...', 'info');
        return;
      }

      if (isAuthenticated && currentUser) {
        loginForm.style.display = 'none';
        dashboard.style.display = 'block';
        welcomeMessage.textContent = `Hello, ${currentUser.firstName} ${currentUser.lastName}! Role: ${currentUser.role}`;
        log('‚úÖ Dashboard shown - user is authenticated', 'success');
      } else {
        loginForm.style.display = 'block';
        dashboard.style.display = 'none';
        log('üìù Login form shown - user not authenticated', 'info');
      }
    }

    async function simulateLogin() {
      clearLog();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      log(`üöÄ Starting login simulation for: ${email}`, 'info');

      try {
        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 500));

        // Demo users (exact same as in the React app)
        const demoUsers = [
          {
            credentials: ['admin@iotflow.com', 'admin'],
            password: 'admin123',
            user: {
              id: 1,
              username: 'admin',
              email: 'admin@iotflow.com',
              firstName: 'Admin',
              lastName: 'User',
              role: 'admin',
              api_key: 'admin_api_key_demo_secure_token_123',
              tenant_id: 1,
              permissions: ['admin', 'user_management', 'system_access'],
              createdAt: new Date().toISOString(),
              lastLogin: new Date().toISOString()
            }
          },
          {
            credentials: ['john@iotflow.com', 'john'],
            password: 'john123',
            user: {
              id: 2,
              username: 'john',
              email: 'john@iotflow.com',
              firstName: 'John',
              lastName: 'Smith',
              role: 'user',
              api_key: 'john_api_key_demo_secure_token_456',
              tenant_id: 2,
              permissions: ['device_access', 'telemetry_read'],
              createdAt: new Date(Date.now() - 86400000 * 15).toISOString(),
              lastLogin: new Date().toISOString()
            }
          }
        ];

        const matchedUser = demoUsers.find(user =>
          user.credentials.some(cred =>
            cred.toLowerCase() === email.toLowerCase()
          ) && user.password === password
        );

        if (matchedUser) {
          log(`‚úÖ User found: ${matchedUser.user.username}`, 'success');

          // Store in localStorage (exactly like React app)
          localStorage.setItem('iotflow_user', JSON.stringify(matchedUser.user));
          localStorage.setItem('iotflow_user_api_key', matchedUser.user.api_key);
          localStorage.removeItem('iotflow_devices_cache');

          log('üíæ Data stored in localStorage', 'success');

          // Update state (like React app)
          isAuthenticated = true;
          currentUser = matchedUser.user;
          isLoading = false;

          log('üîÑ State updated: isAuthenticated = true', 'success');
          log(`<pre>Current User:\n${JSON.stringify(currentUser, null, 2)}</pre>`, 'info');

          // Update UI
          updateUI();

          log('üéâ LOGIN SUCCESSFUL!', 'success');
        } else {
          log('‚ùå Invalid credentials', 'error');
          isAuthenticated = false;
          currentUser = null;
          updateUI();
        }

      } catch (error) {
        log(`‚ùå Login failed: ${error.message}`, 'error');
        isAuthenticated = false;
        currentUser = null;
        updateUI();
      }
    }

    function simulateLogout() {
      clearLog();
      log('üö™ Logging out...', 'info');

      // Clear localStorage
      localStorage.removeItem('iotflow_user_api_key');
      localStorage.removeItem('iotflow_user');
      localStorage.removeItem('iotflow_devices_cache');

      // Update state
      isAuthenticated = false;
      currentUser = null;

      log('üóëÔ∏è LocalStorage cleared', 'success');
      log('üîÑ State updated: isAuthenticated = false', 'success');

      // Update UI
      updateUI();
      log('‚úÖ Logout successful', 'success');
    }

    function clearLocalStorage() {
      localStorage.clear();
      log('üóëÔ∏è All localStorage cleared', 'success');
      checkAuthentication();
    }

    function checkAuthentication() {
      clearLog();
      log('üîç Checking authentication state...', 'info');

      const userApiKey = localStorage.getItem('iotflow_user_api_key');
      const userData = localStorage.getItem('iotflow_user');

      log(`API Key in localStorage: ${userApiKey ? '‚úÖ Present' : '‚ùå Missing'}`, userApiKey ? 'success' : 'error');
      log(`User Data in localStorage: ${userData ? '‚úÖ Present' : '‚ùå Missing'}`, userData ? 'success' : 'error');

      if (userApiKey && userData) {
        try {
          const parsedUser = JSON.parse(userData);
          if (parsedUser && parsedUser.id && parsedUser.email) {
            isAuthenticated = true;
            currentUser = parsedUser;
            isLoading = false;
            log('‚úÖ Authentication restored from localStorage', 'success');
            log(`<pre>Restored User:\n${JSON.stringify(parsedUser, null, 2)}</pre>`, 'info');
          } else {
            log('‚ùå Invalid user data structure', 'error');
            isAuthenticated = false;
            currentUser = null;
          }
        } catch (error) {
          log(`‚ùå Failed to parse user data: ${error.message}`, 'error');
          isAuthenticated = false;
          currentUser = null;
        }
      } else {
        isAuthenticated = false;
        currentUser = null;
      }

      isLoading = false;
      log(`Current state: isAuthenticated=${isAuthenticated}, user=${currentUser?.username || 'none'}`, 'info');
      updateUI();
    }

    // Initialize
    window.onload = function () {
      checkAuthentication();
    };
  </script>
</body>

</html>