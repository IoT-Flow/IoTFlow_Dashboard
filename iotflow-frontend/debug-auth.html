<!DOCTYPE html>
<html>

<head>
  <title>Auth Debug Test</title>
</head>

<body>
  <h1>IoTFlow Auth Debug</h1>
  <button onclick="testLogin()">Test Demo Login</button>
  <button onclick="clearStorage()">Clear Storage</button>
  <button onclick="checkStorage()">Check Storage</button>
  <div id="output"></div>

  <script>
    function log(message) {
      document.getElementById('output').innerHTML += '<p>' + message + '</p>';
      console.log(message);
    }

    function clearStorage() {
      localStorage.removeItem('iotflow_user_api_key');
      localStorage.removeItem('iotflow_user');
      localStorage.removeItem('iotflow_devices_cache');
      log('Storage cleared');
    }

    function checkStorage() {
      const apiKey = localStorage.getItem('iotflow_user_api_key');
      const user = localStorage.getItem('iotflow_user');
      log('API Key: ' + (apiKey ? 'Present' : 'Not found'));
      log('User: ' + (user ? 'Present' : 'Not found'));
      if (user) {
        try {
          const parsed = JSON.parse(user);
          log('User data: ' + JSON.stringify(parsed, null, 2));
        } catch (e) {
          log('User data parse error: ' + e.message);
        }
      }
    }

    async function testLogin() {
      log('Testing login with admin@iotflow.com / admin123');

      // Clear any existing data
      clearStorage();

      // Test the demo authentication logic
      const demoUsers = [
        {
          credentials: ['admin@iotflow.com', 'admin'],
          password: 'admin123',
          user: {
            id: 1,
            username: 'admin',
            email: 'admin@iotflow.com',
            firstName: 'Admin',
            lastName: 'User',
            role: 'admin',
            api_key: 'admin_api_key_demo_secure_token_123',
            tenant_id: 1,
            permissions: ['admin', 'user_management', 'system_access'],
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
          }
        }
      ];

      const emailOrUsername = 'admin@iotflow.com';
      const password = 'admin123';

      const matchedUser = demoUsers.find(user =>
        user.credentials.some(cred =>
          cred.toLowerCase() === emailOrUsername.toLowerCase()
        ) && user.password === password
      );

      if (matchedUser) {
        log('Demo user matched: ' + JSON.stringify(matchedUser.user, null, 2));

        // Store authentication data in localStorage
        localStorage.setItem('iotflow_user', JSON.stringify(matchedUser.user));
        localStorage.setItem('iotflow_user_api_key', matchedUser.user.api_key);

        log('Data stored in localStorage');
        checkStorage();
      } else {
        log('No matching user found');
      }
    }
  </script>
</body>

</html>